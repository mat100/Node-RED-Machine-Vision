#!/bin/bash
#
# Machine Vision Backend CLI wrapper
# This script provides easy management of the Machine Vision service
#

set -e

VERSION_FILE="/usr/lib/machinevision/VERSION"
BACKUP_DIR="/var/backups/machinevision"
SERVICE_NAME="machinevision.service"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_error() {
    echo -e "${RED}Error: $1${NC}" >&2
}

print_success() {
    echo -e "${GREEN}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}Warning: $1${NC}"
}

print_usage() {
    cat <<EOF
Usage: machinevision [COMMAND]

Commands:
    start       Start the Machine Vision service
    stop        Stop the Machine Vision service
    restart     Restart the Machine Vision service
    status      Show service status
    logs        Show service logs (use -f to follow)
    version     Show installed version
    rollback    Rollback to previous version
    help        Show this help message

Examples:
    machinevision start
    machinevision logs -f
    machinevision rollback

EOF
}

check_root() {
    if [ "$EUID" -ne 0 ]; then
        print_error "This command requires root privileges. Use sudo."
        exit 1
    fi
}

get_version() {
    if [ -f "$VERSION_FILE" ]; then
        cat "$VERSION_FILE"
    else
        echo "unknown"
    fi
}

cmd_start() {
    check_root
    echo "Starting Machine Vision service..."
    systemctl start "$SERVICE_NAME"
    print_success "Service started successfully"
}

cmd_stop() {
    check_root
    echo "Stopping Machine Vision service..."
    systemctl stop "$SERVICE_NAME"
    print_success "Service stopped successfully"
}

cmd_restart() {
    check_root
    echo "Restarting Machine Vision service..."
    systemctl restart "$SERVICE_NAME"
    print_success "Service restarted successfully"
}

cmd_status() {
    systemctl status "$SERVICE_NAME" --no-pager
}

cmd_logs() {
    shift # Remove 'logs' from arguments
    if [ "$1" = "-f" ] || [ "$1" = "--follow" ]; then
        journalctl -u "$SERVICE_NAME" -f
    else
        journalctl -u "$SERVICE_NAME" --no-pager -n 50
    fi
}

cmd_version() {
    local version=$(get_version)
    echo "Machine Vision Backend version: $version"

    # Check if service is running
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        print_success "Service is running"
    else
        echo "Service is not running"
    fi
}

cmd_rollback() {
    check_root

    if [ ! -d "$BACKUP_DIR" ]; then
        print_error "No backups found in $BACKUP_DIR"
        exit 1
    fi

    # Find latest backup
    LATEST_APP_BACKUP=$(ls -t "$BACKUP_DIR"/backup-*-app.tar.gz 2>/dev/null | head -n 1)
    LATEST_CONFIG_BACKUP=$(ls -t "$BACKUP_DIR"/backup-*-config.tar.gz 2>/dev/null | head -n 1)

    if [ -z "$LATEST_APP_BACKUP" ]; then
        print_error "No application backup found"
        exit 1
    fi

    # Extract backup timestamp
    BACKUP_TIMESTAMP=$(basename "$LATEST_APP_BACKUP" | sed 's/backup-\(.*\)-app.tar.gz/\1/')
    VERSION_FILE_BACKUP="$BACKUP_DIR/backup-$BACKUP_TIMESTAMP.version"

    if [ -f "$VERSION_FILE_BACKUP" ]; then
        ROLLBACK_VERSION=$(cat "$VERSION_FILE_BACKUP")
        echo "Found backup from version: $ROLLBACK_VERSION"
    else
        echo "Found backup from: $BACKUP_TIMESTAMP"
    fi

    # Confirm rollback
    read -p "Do you want to rollback to this version? (yes/no): " CONFIRM
    if [ "$CONFIRM" != "yes" ]; then
        echo "Rollback cancelled"
        exit 0
    fi

    echo "Stopping service..."
    systemctl stop "$SERVICE_NAME" || true

    echo "Rolling back application files..."
    rm -rf /usr/lib/machinevision
    mkdir -p /usr/lib
    tar -xzf "$LATEST_APP_BACKUP" -C /usr/lib

    if [ -n "$LATEST_CONFIG_BACKUP" ]; then
        echo "Rolling back configuration..."
        rm -rf /etc/machinevision
        mkdir -p /etc
        tar -xzf "$LATEST_CONFIG_BACKUP" -C /etc
    fi

    # Fix permissions
    chown -R machinevision:machinevision /usr/lib/machinevision

    echo "Reloading systemd..."
    systemctl daemon-reload

    echo "Starting service..."
    systemctl start "$SERVICE_NAME"

    print_success "Rollback completed successfully!"
    cmd_version
}

# Main command dispatcher
case "${1:-}" in
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    restart)
        cmd_restart
        ;;
    status)
        cmd_status
        ;;
    logs)
        cmd_logs "$@"
        ;;
    version)
        cmd_version
        ;;
    rollback)
        cmd_rollback
        ;;
    help|--help|-h)
        print_usage
        ;;
    "")
        print_error "No command specified"
        print_usage
        exit 1
        ;;
    *)
        print_error "Unknown command: $1"
        print_usage
        exit 1
        ;;
esac

exit 0
